# %%
import numpy as np
from caveclient import CAVEclient
from joblib import Parallel, delayed

from pkg.edits import get_detailed_change_log

client = CAVEclient("minnie65_phase3_v1")

root_ids = [
    864691135163673901,
    864691135617152361,
    864691136090326071,
    864691135565870679,
    864691135510120201,
    864691135214129208,
    864691135759725134,
    864691135256861871,
    864691135759685966,
    864691135946980644,
    864691134941217635,
    864691136275234061,
    864691135741431915,
    864691135361314119,
    864691135777918816,
    864691136137805181,
    864691135737446276,
    864691136451680255,
    864691135468657292,
    864691135578006277,
    864691136452245759,
    864691135916365670,
    864691136444709251,
    864691136419262359,
    864691135772461899,
    864691134885546234,
    864691135488240954,
    864691135494071184,
    864691135502015413,
    864691135502796786,
    864691135349073367,
    864691135639686715,
    864691136227718481,
    864691135517046483,
    864691135615776617,
    864691135884888688,
    864691136912519153,
    864691135867636502,
    864691136578545172,
    864691135569854598,
    864691135754580178,
    864691135616723561,
    864691135864572542,
    864691135837183123,
    864691137054709110,
    864691135865552005,
    864691135209116537,
    864691135374585929,
    864691135163225133,
    864691135945455140,
    864691135951996707,
    864691136923780580,
    864691136004733130,
    864691135884808560,
    864691136194514252,
    864691135304099751,
    864691136272926654,
    864691135938132484,
    864691136296646171,
    864691136361511394,
    864691136482909996,
    864691136518542052,
    864691136437377950,
    864691134965364255,
    864691136801459054,
    864691136829413860,
    864691135741169515,
    864691136906709102,
]

root_ids = np.unique(root_ids)


def get_change_log(root_id):
    client = CAVEclient("minnie65_phase3_v1")
    out = get_detailed_change_log(root_id, client)
    out["root_id"] = root_id
    return out


change_logs = Parallel(n_jobs=-1, verbose=10)(
    delayed(get_change_log)(root_id) for root_id in root_ids
)

# %%
import pandas as pd

change_log = pd.concat(change_logs)
change_log["is_merge"] = change_log["is_merge"].astype(bool)
splits = change_log[~change_log["is_merge"]]
